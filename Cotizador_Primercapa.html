<!-- language: HTML+JS -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizadores 3D (Refactorizado)</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-start justify-center">

<div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6">

    <!-- TABS -->
    <div class="flex border-b mb-6">
        <button class="tab-btn px-4 py-2 font-semibold border-b-2 border-indigo-600 text-indigo-600"
                data-tab="diseno">Diseño 3D</button>
        <button class="tab-btn px-4 py-2 font-semibold text-gray-500 hover:text-indigo-600"
                data-tab="impresion">Impresión 3D</button>
    </div>

    <!-- ===================== DISEÑO 3D ===================== -->
    <section id="tab-diseno">
       <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Cotizador de Diseño 3D</h1>
        <p class="text-center text-gray-500 mb-8">Calcula el precio de tu proyecto de diseño de piezas mecánicas.</p>
        <form id="cotizadorFormDiseno" class="space-y-6" aria-label="Cotizador Diseño 3D">
            <!-- ... [contenido igual que original exceptuando los id conflictivos] ... -->
            <!-- Cambiar id de resultContainer y totalText -->
            <div class="pt-6 border-t border-gray-200 mt-6 flex flex-col items-center">
                <div id="resultContainerDiseno" class="mb-4 text-center">
                    <p id="totalTextDiseno" class="text-2xl font-bold text-gray-800">Precio Total: $0.00</p>
                </div>
                <div class="w-full flex flex-col sm:flex-row gap-4">
                    <button type="button" id="cotizarBtnDiseno" class="flex-1 w-full sm:w-auto px-4 py-2 text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150">
                        Cotizar
                    </button>
                    <button type="button" id="guardarBtnDiseno" disabled class="flex-1 w-full sm:w-auto px-4 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Cotización aceptada
                    </button>
                </div>
                <div id="messageBoxDiseno" class="mt-4 p-4 rounded-lg text-center w-full hidden" role="alert"></div>
            </div>
        </form>
    </section>

    <!-- ===================== IMPRESIÓN 3D ===================== -->
    <section id="tab-impresion" class="hidden">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Cotizador de Impresión 3D</h1>
        <p class="text-center text-gray-500 mb-8">Calcula el precio de tu proyecto de impresión 3D.</p>
        <form id="cotizadorFormImpresion" class="space-y-6" aria-label="Cotizador Impresión 3D">
            <!-- ... [contenido igual que original exceptuando los id conflictivos] ... -->
            <!-- Cambiar id de resultContainer y totalText -->
            <div class="pt-6 border-t border-gray-200 mt-6 flex flex-col items-center">
                <div id="resultContainerImpresion" class="mb-4 text-center space-y-2 w-full">
                    <p id="totalTextImpresion" class="text-xl font-bold text-gray-800">
                        Costo de fabricación: <span id="totalDisplayImpresion" class="text-indigo-600">0.00</span>
                    </p>
                    <div id="ventaContainerImpresion" class="hidden">
                        <label for="precioVentaImpresion" class="block text-sm font-medium text-gray-700 mb-1">Precio sugerido de venta sin IVA</label>
                        <input type="number" id="precioVentaImpresion" name="precioVentaImpresion" min="0" step="0.01" required
                                class="mt-1 block w-full px-4 py-2 bg-gray-100 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                value="0.00">
                    </div>          
                </div>
                <div class="w-full flex flex-col sm:flex-row gap-4">
                    <button type="button" id="btnCalcularImpresion" class="flex-1 w-full sm:w-auto px-4 py-2 text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150">
                        Cotizar
                    </button>
                    <button type="button" id="btnGuardarImpresion" disabled class="flex-1 w-full sm:w-auto px-4 py-2 text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Cotización aceptada
                    </button>
                </div>
                <div id="messageBoxImpresion" class="mt-4 p-4 rounded-lg text-center w-full hidden" role="alert"></div>
            </div>
        </form>
    </section>
</div>

<script>
/* ===================== CONSTANTES ===================== */
const WEB_APP_URL_DISENO = 'https://script.google.com/macros/s/AKfycby8stnQMyn8qVifOiBD_-1jC9E-XYRNXZUd20JC8vBgqB-JW_uwxwTndcSIIiA2q1QPPA/exec';
const WEB_APP_URL_IMPRESION = 'https://script.google.com/macros/s/AKfycbzx9YhWoTAG7k_wBABnLz2O0UtkECMASV3ELgk4iqS51gzan2q-UWzcySqRzqd_SVte/exec';

const COSTO_FIJO_IMPRESION = 15;
const COSTO_FIJO_VENTA = 20;
const MULTIPLICADOR_VENTA = 3;
const MULTIPLICADOR_TIEMPO_IMPRESION = 2;

/* ===================== Función Tab General ===================== */
/**
 * Cambia entre las pestañas mostrando el formulario correspondiente y ocultando los demás.
 * @param {string} activeTabId - El id de la pestaña a mostrar ('diseno' o 'impresion')
 */
function switchTab(activeTabId) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-indigo-600','text-indigo-600');
        if (btn.dataset.tab === activeTabId)
            btn.classList.add('border-indigo-600','text-indigo-600');
    });
    // Oculta las secciones e imprime la activa
    document.getElementById('tab-diseno').classList.toggle('hidden', activeTabId !== 'diseno');
    document.getElementById('tab-impresion').classList.toggle('hidden', activeTabId !== 'impresion');
}

/* ===================== Helper Genérico ===================== */
/**
 * Muestra un mensaje en pantalla en el contenedor dado. Soporta tipo colores y scroll a zona visible.
 * @param {HTMLElement} container - El elemento contenedor del mensaje
 * @param {string} message - El texto a mostrar
 * @param {'success'|'error'|'info'|'warning'} type - El tipo/color de alerta
 */
function showMessage(container, message, type='info') {
    const COLOR_MAP = {
        success: ['bg-green-100','text-green-700'],
        error: ['bg-red-100','text-red-700'],
        info: ['bg-blue-100','text-blue-700'],
        warning: ['bg-yellow-100','text-yellow-700'],
        default: ['bg-gray-100','text-gray-700']
    };
    const colors = COLOR_MAP[type] || COLOR_MAP['default'];
    container.textContent = message;
    container.className = `mt-4 p-4 rounded-lg text-center w-full ${colors.join(' ')}`;
    container.style.display = 'block';
    container.classList.remove('hidden');
    container.setAttribute('role', 'alert');
    container.setAttribute('aria-live', 'polite');
    container.scrollIntoView({behavior: "smooth", block: "center"});
}

/* ===================== Validaciones ===================== */
/**
 * Valida los campos requeridos del formulario de diseño 3D.
 * @param {HTMLFormElement} formDiseno
 * @returns {string|null} Mensaje de error, o null si todo OK
 */
function validateFormDiseno(formDiseno) {
    const nombreProyecto = formDiseno.querySelector('#nombreProyecto').value.trim();
    if (!nombreProyecto)
        return 'El nombre del proyecto es obligatorio.';
    const precioUnitario = formDiseno.querySelector('#precioUnitario');
    const puVal = parseFloat(precioUnitario.value);
    if (isNaN(puVal) || puVal <= 0)
        return 'El precio por punto debe ser mayor que cero.';
    const categorias = ['claridad','funcionalidad','precision','iteraciones','entrega','urgencia'];
    for (const cat of categorias) {
        if (!formDiseno.querySelector(`input[name="${cat}"]:checked`))
            return `Falta seleccionar una opción en la categoría de ${cat}.`;
    }
    return null;
}

/**
 * Valida los campos requeridos del formulario de impresión 3D.
 * @param {HTMLFormElement} formImpresion
 * @returns {string|null} Mensaje de error, o null si todo OK
 */
function validateFormImpresion(formImpresion) {
    const producto = formImpresion.querySelector('#producto').value.trim();
    if (!producto)
        return 'El nombre del producto es obligatorio.';
    const campos = [
        {id:'tiempoHoras', label:'Horas'},
        {id:'tiempoMinutos', label:'Minutos'},
        {id:'gramos', label:'Gramos'},
        {id:'accesorios', label:'Accesorios'}
    ];
    for (const cam of campos) {
        const elem = formImpresion.querySelector('#'+cam.id);
        const val = parseFloat(elem.value);
        if (isNaN(val) || val < 0)
            return `El campo "${cam.label}" debe ser un número positivo.`;
    }
    const materialRadio = formImpresion.querySelector('input[name="material"]:checked');
    if (!materialRadio)
        return 'Seleccione un material.';
    return null;
}

/* ===================== LÓGICA DE DISEÑO 3D ===================== */
const formDiseno = document.getElementById('cotizadorFormDiseno');
const cotizarBtnDiseno = document.getElementById('cotizarBtnDiseno');
const guardarBtnDiseno = document.getElementById('guardarBtnDiseno');
const totalTextDiseno = document.getElementById('totalTextDiseno');
const messageBoxDiseno = document.getElementById('messageBoxDiseno');

cotizarBtnDiseno.addEventListener('click', function() {
    messageBoxDiseno.style.display = 'none';
    messageBoxDiseno.classList.add('hidden');
    guardarBtnDiseno.disabled = true;
    const error = validateFormDiseno(formDiseno);
    if (error) {
        showMessage(messageBoxDiseno, error, 'error');
        return;
    }
    // Calcula el total
    const precioUnitario = parseFloat(formDiseno.querySelector('#precioUnitario').value);
    const categorias = ['claridad','funcionalidad','precision','iteraciones','entrega','urgencia'];
    let sumatoriaPuntos = 0;
    categorias.forEach(cat => {
        const checkedRadio = formDiseno.querySelector(`input[name="${cat}"]:checked`);
        sumatoriaPuntos += parseInt(checkedRadio.value);
    });
    const total = sumatoriaPuntos * precioUnitario;
    totalTextDiseno.textContent = `Precio Total Estimado: $${total.toFixed(2)}`;
    guardarBtnDiseno.disabled = false;
    showMessage(messageBoxDiseno, 'Cotización calculada con éxito.', 'success');
});

guardarBtnDiseno.addEventListener('click', async function() {
    guardarBtnDiseno.disabled = true;
    const error = validateFormDiseno(formDiseno);
    if (error) {
        showMessage(messageBoxDiseno, error, 'error');
        guardarBtnDiseno.disabled = false;
        return;
    }
    showMessage(messageBoxDiseno, 'Enviando cotización...', 'info');
    const categorias = ['claridad','funcionalidad','precision','iteraciones','entrega','urgencia'];
    const selectedData = {};
    categorias.forEach(cat => {
        const checkedRadio = formDiseno.querySelector(`input[name="${cat}"]:checked`);
        selectedData[cat] = {
            valor: parseInt(checkedRadio.value),
            texto: checkedRadio.dataset.text
        };
    });
    const nombreProyecto = formDiseno.querySelector('#nombreProyecto').value;
    const precioUnitario = parseFloat(formDiseno.querySelector('#precioUnitario').value);
    const total = parseFloat(totalTextDiseno.textContent.replace('Precio Total Estimado: $', ''));
    const payload = {
        nombreProyecto,
        ...selectedData,
        precioUnitario,
        total: Number.isFinite(total) ? total : ''
    };
    try {
        await fetch(WEB_APP_URL_DISENO, {
            method: 'POST',
            mode: 'no-cors',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        showMessage(messageBoxDiseno, 'Cotización guardada exitosamente. ¡Gracias!', 'success');
        formDiseno.reset();
        guardarBtnDiseno.disabled = true;
        cotizarBtnDiseno.disabled = false;
        totalTextDiseno.textContent = 'Precio Total: $0.00';
    } catch(e) {
        showMessage(messageBoxDiseno, 'Error al guardar la cotización. Por favor, inténtelo de nuevo.', 'error');
        guardarBtnDiseno.disabled = false;
    }
});

/* ===================== LÓGICA DE IMPRESIÓN 3D ===================== */
const formImpresion = document.getElementById('cotizadorFormImpresion');
const btnCalcularImpresion = document.getElementById('btnCalcularImpresion');
const btnGuardarImpresion = document.getElementById('btnGuardarImpresion');
const totalDisplayImpresion = document.getElementById('totalDisplayImpresion');
const ventaContainerImpresion = document.getElementById('ventaContainerImpresion');
const precioVentaInputImpresion = document.getElementById('precioVentaImpresion');
const messageBoxImpresion = document.getElementById('messageBoxImpresion');

/**
 * Calcula el costo de fabricación y sugerido de venta de impresión 3D basado en campos del formulario.
 * Rango de minutos > 60 se normaliza a horas.
 */
btnCalcularImpresion.addEventListener('click', function() {
    messageBoxImpresion.style.display = 'none';
    messageBoxImpresion.classList.add('hidden');
    btnGuardarImpresion.disabled = true;
    ventaContainerImpresion.classList.add('hidden');
    // Validación
    const error = validateFormImpresion(formImpresion);
    if (error) {
        showMessage(messageBoxImpresion, error, 'error');
        totalDisplayImpresion.textContent = '0.00';
        return;
    }

    let tiempoHoras = parseFloat(formImpresion.querySelector('#tiempoHoras').value) || 0;
    let tiempoMinutos = parseFloat(formImpresion.querySelector('#tiempoMinutos').value) || 0;
    // Si minutos > 60 normalizar
    if (tiempoMinutos > 60) {
        tiempoHoras += Math.floor(tiempoMinutos / 60);
        tiempoMinutos = tiempoMinutos % 60;
    }
    const gramos = parseFloat(formImpresion.querySelector('#gramos').value) || 0;
    const accesorios = parseFloat(formImpresion.querySelector('#accesorios').value) || 0;
    const material = parseFloat(formImpresion.querySelector('input[name="material"]:checked').value) || 0;

    const precioFabricacion = (tiempoHoras + (tiempoMinutos / 60)) * MULTIPLICADOR_TIEMPO_IMPRESION + (gramos * material) + accesorios + COSTO_FIJO_IMPRESION;
    const precioVentaSugerido = ((tiempoHoras + (tiempoMinutos / 60)) * MULTIPLICADOR_TIEMPO_IMPRESION + (gramos * material)) * MULTIPLICADOR_VENTA + accesorios + COSTO_FIJO_VENTA;

    totalDisplayImpresion.textContent = precioFabricacion.toFixed(2);
    precioVentaInputImpresion.value = precioVentaSugerido.toFixed(2);

    ventaContainerImpresion.classList.remove('hidden');
    btnGuardarImpresion.disabled = false;
    showMessage(messageBoxImpresion, 'Cotización calculada con éxito.', 'success');
});

/**
 * Envía los datos del cotizador de impresión al servidor.
 * Limpia el formulario y bloquea el botón tras guardar.
 */
btnGuardarImpresion.addEventListener('click', async function() {
    btnGuardarImpresion.disabled = true;
    const error = validateFormImpresion(formImpresion);
    if (error) {
        showMessage(messageBoxImpresion, error, 'error');
        btnGuardarImpresion.disabled = false;
        return;
    }
    showMessage(messageBoxImpresion, 'Enviando...', 'info');
    const datos = {
        producto: formImpresion.querySelector('#producto').value,
        tiempoHoras: formImpresion.querySelector('#tiempoHoras').value,
        tiempoMinutos: formImpresion.querySelector('#tiempoMinutos').value,
        gramos: formImpresion.querySelector('#gramos').value,
        accesorios: formImpresion.querySelector('#accesorios').value,
        material: formImpresion.querySelector('input[name="material"]:checked').id,
        precioTotal: totalDisplayImpresion.textContent,
        precioVenta: precioVentaInputImpresion.value
    };
    const formData = new FormData();
    for (const key in datos) {
        formData.append(key, datos[key]);
    }
    try {
        const response = await fetch(WEB_APP_URL_IMPRESION, { method: 'POST', body: formData });
        const result = await response.text();
        // En modo no-cors esto será vacío, pero lo mostramos igual
        showMessage(messageBoxImpresion, result || 'Cotización guardada exitosamente. ¡Gracias!', 'success');
        formImpresion.reset();
        btnGuardarImpresion.disabled = true;
        btnCalcularImpresion.disabled = false;
        totalDisplayImpresion.textContent = '0.00';
        ventaContainerImpresion.classList.add('hidden');
    } catch (error) {
        showMessage(messageBoxImpresion, 'Error al guardar datos. Intente de nuevo.', 'error');
        btnGuardarImpresion.disabled = false;
    }
});

/* ===================== Eventos de TABS ===================== */
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        switchTab(btn.dataset.tab);
    });
});
switchTab('diseno'); // Inicialmente muestra diseño
</script>
</body>
</html>